From 8a5f13173cbc21b4c21b0fc97370f9882ef4cd94 Mon Sep 17 00:00:00 2001
From: Lonnie Abelbeck <lonnie@abelbeck.com>
Date: Mon, 3 Aug 2015 17:11:00 -0500
Subject: [PATCH] fixed: Issue #17, Enable xtables lock "wait" option found in
 iptables 1.4.20+

---
 share/arno-iptables-firewall/environment | 15 +++++++++++----
 1 file changed, 11 insertions(+), 4 deletions(-)

diff --git a/share/arno-iptables-firewall/environment b/share/arno-iptables-firewall/environment
index 0fe708f..bc2d24e 100644
--- a/share/arno-iptables-firewall/environment
+++ b/share/arno-iptables-firewall/environment
@@ -296,7 +296,7 @@ ip4tables()
 {
   local result retval IFS=' '
 
-  result=`$IP4TABLES "$@" 2>&1`
+  result=`$IP4TABLES${IPTABLES_OPTIONS:+ $IPTABLES_OPTIONS} "$@" 2>&1`
   retval=$?
 
   if [ $retval -ne 0 ]; then
@@ -323,7 +323,7 @@ ip6tables()
 {
   local result retval IFS=' '
 
-  result=`$IP6TABLES "$@" 2>&1`
+  result=`$IP6TABLES${IPTABLES_OPTIONS:+ $IPTABLES_OPTIONS} "$@" 2>&1`
   retval=$?
 
   if [ $retval -ne 0 ]; then
@@ -422,7 +422,7 @@ try_ip4tables()
 {
   local IFS=' '
 
-  $IP4TABLES "$@" >/dev/null 2>&1
+  $IP4TABLES${IPTABLES_OPTIONS:+ $IPTABLES_OPTIONS} "$@" >/dev/null 2>&1
 }
 
 
@@ -430,7 +430,7 @@ try_ip6tables()
 {
   local IFS=' '
 
-  $IP6TABLES "$@" >/dev/null 2>&1
+  $IP6TABLES${IPTABLES_OPTIONS:+ $IPTABLES_OPTIONS} "$@" >/dev/null 2>&1
 }
 
 
@@ -1672,6 +1672,13 @@ if [ -z "$DIG" ]; then
   NSLOOKUP="$(find_command /usr/bin/nslookup)"
 fi
 
+# Enable xtables lock "wait" option found in iptables 1.4.20+
+if $IP4TABLES -w --version >/dev/null 2>&1; then
+  IPTABLES_OPTIONS="-w"
+else
+  IPTABLES_OPTIONS=""
+fi
+
 # Setup IPv6 detected environment variable
 if sysctl_key net.ipv6.conf; then
   IPV6_DETECTED=1
