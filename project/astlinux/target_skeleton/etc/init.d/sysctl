#!/bin/sh

. /etc/rc.conf

gen_sysctl_conf()
{
  local i param value IFS

  unset IFS
  for i in $KERNEL_SYSCTL; do
    param="$(echo "$i" | cut -s -d'=' -f1)"
    value="$(echo "$i" | cut -s -d'=' -f2)"
    if [ -n "$param" -a -n "$value" ]; then
      echo "$param = $value"
    fi
  done
}

init () {

  if [ -f /mnt/kd/sysctl.conf ]; then
    echo "# Autogenerated.  Edit /mnt/kd/sysctl.conf file.
" > /tmp/etc/sysctl.conf
    cat /mnt/kd/sysctl.conf >>/tmp/etc/sysctl.conf
  elif [ -n "$KERNEL_SYSCTL" ]; then
    echo "# Autogenerated.  Do not edit.
# A manually generated sysctl config will use /mnt/kd/sysctl.conf if it exists.
" > /tmp/etc/sysctl.conf
    gen_sysctl_conf >>/tmp/etc/sysctl.conf
  elif [ -f /etc/sysctl.conf ]; then
    rm -f /tmp/etc/sysctl.conf
  fi
}

start () {

  if [ -f /etc/sysctl.conf ]; then
    echo "Setting kernel runtime parameters..."
    sysctl -p /etc/sysctl.conf >/dev/null
  fi
}

stop () {
  :
}

case $1 in

start)
  start
  ;;

stop)
  stop
  ;;

init)
  init
  start
  ;;

restart)
  stop
  sleep 2
  start
  ;;

*)
  echo "Usage: start|stop|restart"
  ;;

esac

